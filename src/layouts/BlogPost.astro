---
// Blog post layout with dark theme
import { Image } from 'astro:assets';
import { getEntry, type CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Background from '../components/Background.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import NavBar from '../components/NavBar.astro';
type Props = CollectionEntry<'blog'>['data'] & {
	slug: string;
};

const props = Astro.props as Props;
const { title, description, pubDate, updatedDate, heroImage, category, author, authorId, slug } = props;

// Configure the external views API base (e.g. https://your-app.vercel.app).
// For GitHub Pages, this MUST be set to your deployed API origin.
const viewsApiBase = (import.meta.env.PUBLIC_API_BASE ?? '').replace(/\/+$/, '');

let resolvedAuthor = author;
if (authorId) {
	try {
		const entry = await getEntry('authors', authorId);
		if (entry) resolvedAuthor = entry.data;
	} catch {
		// Ignore missing/invalid authorId
	}
}
const avatarSrc = resolvedAuthor?.avatarImage || resolvedAuthor?.avatarUrl;
const websiteHref = (() => {
	const raw = (resolvedAuthor?.website ?? '').trim();
	if (!raw) return '';
	// If no scheme provided, treat it as an https URL (avoid relative navigation).
	if (/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(raw)) return raw;
	return `https://${raw.replace(/^\/+/, '')}`;
})();
const hasAuthorInfo = Boolean(
	resolvedAuthor && (resolvedAuthor.name || avatarSrc || resolvedAuthor.website),
);
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
		<!-- Katex -->
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
			integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV"
			crossorigin="anonymous"
		/>
	</head>

	<body class="min-h-screen overflow-x-hidden bg-[#050505] font-sans text-gray-300 selection:bg-white/20 selection:text-white">
		<Background />
		<NavBar />
		<main class="post-main">
			<article class="post-article animate-fade-in-up">
				<a href="/" class="back-button">
					<svg
						width="16"
						height="16"
						viewBox="0 0 16 16"
						fill="none"
						stroke="currentColor"
						stroke-width="2"
					>
						<path d="M10 12l-4-4 4-4" />
					</svg>
					<span>Back to posts</span>
				</a>

				<header class="post-header">
					<div class="post-category-badge">
						<span class="category-text">{category}</span>
					</div>
					<h1 class="post-title">{title}</h1>
					<div class="post-meta-info">
						{hasAuthorInfo && (
							<div class="post-author">
								{avatarSrc && (
									<img
										src={avatarSrc}
										alt={resolvedAuthor?.name ? `${resolvedAuthor.name} avatar` : 'Author avatar'}
										class="author-avatar"
										width="24"
										height="24"
									/>
								)}
								{resolvedAuthor?.name && (
									websiteHref ? (
										<a
											href={websiteHref}
											target="_blank"
											rel="noreferrer"
											class="author-name-link"
										>
											{resolvedAuthor.name}
										</a>
									) : (
										<span class="author-name">{resolvedAuthor.name}</span>
									)
								)}
							</div>
						)}
						<div class="post-meta-details">
							<span class="meta-item">
								<svg
									width="14"
									height="14"
									viewBox="0 0 16 16"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
								>
									<rect x="3" y="4" width="10" height="10" rx="1" />
									<path d="M5 2v2M11 2v2M3 6h10" />
								</svg>
								<FormattedDate date={pubDate} />
							</span>
							<span class="meta-item" id="reading-time">
								<svg
									width="14"
									height="14"
									viewBox="0 0 16 16"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
								>
									<circle cx="8" cy="8" r="6" />
									<path d="M8 4v4l3 2" />
								</svg>
								<span id="reading-time-text">—</span> min read
							</span>
							<span class="meta-item" id="post-views" aria-label="Views">
								<svg
									width="14"
									height="14"
									viewBox="0 0 16 16"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
								>
									<path d="M1 8s2.5-5 7-5 7 5 7 5-2.5 5-7 5-7-5-7-5Z" />
									<circle cx="8" cy="8" r="2" />
								</svg>
								<span id="post-views-text">—</span>
							</span>
						</div>
					</div>
					<div class="post-header-divider"></div>
				</header>

				<div class="post-content blog-content">
					<slot />
				</div>

				<div class="post-footer">
					<div class="post-footer-thanks">Thanks for reading.</div>
					<div class="post-footer-share">
						<button
							type="button"
							class="share-button"
							aria-label="Share link"
							data-share="native"
						>
							<svg
								width="18"
								height="18"
								viewBox="0 0 16 16"
								fill="none"
								stroke="currentColor"
								stroke-width="2"
							>
								<circle cx="8" cy="8" r="2" />
								<path d="M8 4v4M8 8l4-4M8 8l-4-4" />
							</svg>
						</button>
						<button
							type="button"
							class="share-button"
							aria-label="Share to X (Twitter)"
							data-share="twitter"
						>
							<svg
								width="18"
								height="18"
								viewBox="0 0 16 16"
								fill="currentColor"
							>
								<path
									d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Zm-.86 13.028h1.36L4.323 2.145H2.865l8.875 11.633Z"
								/>
							</svg>
						</button>
					</div>
				</div>
			</article>
		</main>
		<Footer />
	</body>
</html>

<style>
	body {
		min-height: 100vh;
		overflow-x: hidden;
		background: #050505;
		color: #d1d5db;
	}

	.post-main {
		position: relative;
		z-index: 10;
		margin: 0 auto;
		max-width: 1280px;
		padding: 8rem 1.5rem 5rem;
	}

	.post-article {
		margin: 0 auto;
		max-width: 42rem;
	}

	.back-button {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		margin-bottom: 2rem;
		font-size: 0.875rem;
		color: #6b7280;
		text-decoration: none;
		transition: color 0.2s ease;
	}

	.back-button:hover {
		color: white;
	}

	.back-button svg {
		transition: transform 0.2s ease;
	}

	.back-button:hover svg {
		transform: translateX(-4px);
	}

	.post-header {
		margin-bottom: 2rem;
	}

	.post-category-badge {
		margin-bottom: 1rem;
	}

	.category-text {
		display: inline-block;
		border-radius: 9999px;
		border: 1px solid rgba(255, 255, 255, 0.1);
		background: rgba(255, 255, 255, 0.05);
		padding: 0.25rem 0.75rem;
		font-size: 0.75rem;
		font-weight: 500;
		color: #d1d5db;
	}

	.post-title {
		margin-bottom: 1.5rem;
		font-size: 2rem;
		font-weight: 700;
		line-height: 1.2;
		letter-spacing: -0.025em;
		color: white;
	}

	@media (min-width: 768px) {
		.post-title {
			font-size: 3rem;
		}
	}

	.post-meta-info {
		display: flex;
		flex-wrap: wrap;
		align-items: center;
		gap: 1.5rem;
		margin-bottom: 2rem;
		font-size: 0.875rem;
		letter-spacing: 0.05em;
		color: #9ca3af;
	}

	.post-author {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.author-avatar {
		border-radius: 50%;
		object-fit: cover;
	}

	.author-name-link {
		font-weight: 500;
		color: #e5e7eb;
		text-decoration: none;
		transition: all 0.2s ease;
		text-decoration-color: rgba(255, 255, 255, 0.3);
		text-underline-offset: 4px;
	}

	.author-name-link:hover {
		color: white;
		text-decoration-color: white;
	}

	.author-name {
		font-weight: 500;
		color: #e5e7eb;
	}

	.post-meta-details {
		display: flex;
		align-items: center;
		gap: 1.5rem;
	}

	.meta-item {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.meta-item svg {
		flex-shrink: 0;
	}

	.post-header-divider {
		width: 100%;
		border-top: 1px solid rgba(255, 255, 255, 0.1);
	}

	.post-content {
		margin-bottom: 4rem;
	}

	.post-footer {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding-top: 2rem;
		border-top: 1px solid rgba(255, 255, 255, 0.1);
		color: #6b7280;
	}

	.post-footer-thanks {
		font-size: 0.875rem;
	}

	.post-footer-share {
		display: flex;
		gap: 1rem;
	}

	.share-button {
		background: none;
		border: none;
		color: #6b7280;
		cursor: pointer;
		padding: 0.25rem;
		transition: color 0.2s ease;
	}

	.share-button:hover {
		color: white;
	}
</style>

<script define:vars={{ slug, viewsApiBase }}>
	// Calculate reading time from article content
	function calculateReadingTime() {
		const content = document.querySelector('.post-content');
		if (!content) return;

		const text = content.innerText || content.textContent || '';
		const clean = text.replace(/\s+/g, ' ').trim();
		const englishWords = (clean.match(/[A-Za-z0-9]+/g) ?? []).length;
		const minutes = Math.max(1, Math.ceil(englishWords / 200));

		const readingTimeText = document.getElementById('reading-time-text');
		if (readingTimeText) {
			readingTimeText.textContent = minutes.toString();
		}
	}

	// Calculate reading time when page loads
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', calculateReadingTime);
	} else {
		calculateReadingTime();
	}

	// Views counter
	function getViewsEndpoint() {
		const base = (typeof viewsApiBase === 'string' ? viewsApiBase : '').trim();
		// If API is not set, this falls back to same-origin.
		return `${base}/api/views/${encodeURIComponent(slug)}`;
	}

	function coerceViews(data) {
		const raw = data?.views ?? data?.count ?? data?.result;
		if (typeof raw === 'number' && Number.isFinite(raw)) return raw;
		if (typeof raw === 'string' && raw.trim() !== '' && Number.isFinite(Number(raw))) {
			return Number(raw);
		}
		return null;
	}

	async function loadViews() {
		const text = document.getElementById('post-views-text');
		if (!text) return;

		try {
			const res = await fetch(getViewsEndpoint(), { method: 'GET', mode: 'cors' });
			if (!res.ok) return;
			const data = await res.json();
			const views = coerceViews(data);
			if (views !== null) text.textContent = String(views);
		} catch {
			console.warn('[views] failed to load views. Check CORS and API base:', getViewsEndpoint());
		}
	}

	async function bumpViewsOncePerDay() {
		try {
			const today = new Date().toISOString().slice(0, 10);
			const dedupeKey = `views:${slug}:${today}`;
			if (typeof localStorage === 'undefined') return;
			if (localStorage.getItem(dedupeKey)) return;
			localStorage.setItem(dedupeKey, '1');

			const res = await fetch(getViewsEndpoint(), {
				method: 'POST',
				mode: 'cors',
				keepalive: true,
			});
			if (!res.ok) return;
			const data = await res.json().catch(() => null);
			const text = document.getElementById('post-views-text');
			const views = coerceViews(data);
			if (text && views !== null) text.textContent = String(views);
		} catch {
			console.warn('[views] failed to bump views. Check CORS and API base:', getViewsEndpoint());
		}
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', () => {
			loadViews();
			bumpViewsOncePerDay();
		});
	} else {
		loadViews();
		bumpViewsOncePerDay();
	}

	// Share functionality
	const shareButtons = document.querySelectorAll('[data-share]');
	const shareUrl = typeof window !== 'undefined' ? window.location.href : '';
	const shareTitle = document.querySelector('.post-title')?.textContent || '';

	shareButtons.forEach((button) => {
		button.addEventListener('click', async () => {
			const shareType = button.getAttribute('data-share');

			if (shareType === 'twitter') {
				const text = encodeURIComponent(shareTitle);
				const url = encodeURIComponent(shareUrl);
				const intentUrl = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
				window.open(intentUrl, '_blank', 'noopener,noreferrer');
			} else if (shareType === 'native') {
				if (typeof navigator !== 'undefined' && 'share' in navigator) {
					try {
						await navigator.share({ title: shareTitle, url: shareUrl });
						return;
					} catch {
						// User cancelled or error
					}
				}

				// Fallback to clipboard
				if (
					typeof navigator !== 'undefined' &&
					navigator.clipboard?.writeText
				) {
					try {
						await navigator.clipboard.writeText(shareUrl);
						return;
					} catch {
						// Clipboard failed
					}
				}

				// Final fallback
				if (shareUrl) {
					window.prompt('Copy link:', shareUrl);
				}
			}
		});
	});
</script>

