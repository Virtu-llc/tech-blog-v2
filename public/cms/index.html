<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Content Manager</title>
	<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
	<!--
		Decap CMS loads config from "config.yml" by default and GitHub Pages caches it.
		We inject a cache-busting version param to always fetch the latest config.
	-->
	<script>
		(function () {
			var link = document.createElement("link");
			link.rel = "cms-config-url";
			link.type = "text/yaml";
			link.href = "/cms/config.yml?v=" + Date.now();
			document.head.appendChild(link);
		})();
	</script>
</head>
<body>
	<!-- Include the script that builds the page and powers Decap CMS -->
	<script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
	<script>
		// Enable KaTeX math rendering inside Decap CMS preview iframe.
		(function () {
			if (!window.CMS) return;

			// Decap CMS doesn't expose registerPreviewScript in this build,
			// so we inject KaTeX assets directly into the preview iframe.
			var KATEX_CSS = "https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css";
			var KATEX_JS = "https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js";
			var KATEX_AUTORENDER_JS = "https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js";
			var PRISM_CSS = "https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css";
			var PRISM_JS = "https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js";

			function ensureInIframe(iframe) {
				if (!iframe || !iframe.contentDocument) return false;
				var doc = iframe.contentDocument;
				var head = doc.head || doc.getElementsByTagName("head")[0];
				if (!head) return false;

				function ensureLink(id, href) {
					if (doc.getElementById(id)) return;
					var link = doc.createElement("link");
					link.id = id;
					link.rel = "stylesheet";
					link.href = href;
					head.appendChild(link);
				}

				function ensureScript(id, src) {
					if (doc.getElementById(id)) return;
					var s = doc.createElement("script");
					s.id = id;
					s.src = src;
					s.defer = true;
					head.appendChild(s);
				}

				// Minimal code block styles (preserve indentation + readable).
				if (!doc.getElementById("preview-code-style")) {
					var style = doc.createElement("style");
					style.id = "preview-code-style";
					style.textContent = [
						"pre, code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }",
						"pre { white-space: pre; overflow-x: auto; padding: 12px 14px; border-radius: 10px; background: #1f2937; color: #e5e7eb; }",
						"pre code { white-space: pre; }",
						"code { background: rgba(0,0,0,0.05); padding: 0.15em 0.3em; border-radius: 0.25em; }",
						"pre code { background: transparent; padding: 0; }"
					].join("\n");
					head.appendChild(style);
				}

				ensureLink("katex-css", KATEX_CSS);
				ensureScript("katex-js", KATEX_JS);
				ensureScript("katex-auto-render-js", KATEX_AUTORENDER_JS);

				// Prism for code highlighting in preview.
				ensureLink("prism-css", PRISM_CSS);
				ensureScript("prism-js", PRISM_JS);

				// Add a small hook script inside the iframe to auto-render math on updates.
				if (!doc.getElementById("katex-hook")) {
					var hook = doc.createElement("script");
					hook.id = "katex-hook";
					hook.textContent = [
						"(function(){",
						"  function renderMath(){",
						"    if (!window.renderMathInElement) return false;",
						"    try {",
						"      window.renderMathInElement(document.body, {",
						"        delimiters: [",
						"          { left: '$$', right: '$$', display: true },",
						"          { left: '$', right: '$', display: false },",
						"          { left: '\\\\(', right: '\\\\)', display: false },",
						"          { left: '\\\\[', right: '\\\\]', display: true }",
						"        ],",
						"        throwOnError: false",
						"      });",
						"    } catch (e) {}",
						"    return true;",
						"  }",
						"  function renderCode(){",
						"    if (!window.Prism || !window.Prism.highlightAllUnder) return false;",
						"    try { window.Prism.highlightAllUnder(document.body); } catch (e) {}",
						"    return true;",
						"  }",
						"  function renderAll(){",
						"    var okMath = renderMath();",
						"    var okCode = renderCode();",
						"    return okMath || okCode;",
						"  }",
						"  function tick(){",
						"    if (!renderAll()) return setTimeout(tick, 50);",
						"    var obs = new MutationObserver(function(){ renderAll(); });",
						"    obs.observe(document.body, { childList: true, subtree: true });",
						"  }",
						"  if (document.readyState === 'loading') {",
						"    document.addEventListener('DOMContentLoaded', tick);",
						"  } else {",
						"    tick();",
						"  }",
						"})();"
					].join("\n");
					head.appendChild(hook);
				}

				return true;
			}

			// Try to find/inject into preview iframe, and keep watching for it.
			function tryInject() {
				var iframes = document.getElementsByTagName("iframe");
				for (var i = 0; i < iframes.length; i++) {
					try {
						if (ensureInIframe(iframes[i])) return true;
					} catch (_) {
						// Ignore cross-origin/access errors (shouldn't happen on same origin).
					}
				}
				return false;
			}

			var BlogPreview = createClass({
				componentDidMount: function () {
					tryInject();
				},
				componentDidUpdate: function () {
					tryInject();
				},
				render: function () {
					var entry = this.props.entry;
					var body = this.props.widgetFor("body");

					return h("div", { ref: (el) => (this._root = el) },
						h("h1", {}, entry.getIn(["data", "title"]) || ""),
						h("div", {}, body)
					);
				}
			});

			// Collection name is "blog" in config.yml.ts
			CMS.registerPreviewTemplate("blog", BlogPreview);

			// Observe DOM for iframe creation (preview pane mounts lazily).
			var obs = new MutationObserver(function () {
				if (tryInject()) {
					// Once injected, no need to keep observing.
					obs.disconnect();
				}
			});
			obs.observe(document.body, { childList: true, subtree: true });
			// And try immediately.
			tryInject();
		})();
	</script>
	<script>
		if (window.netlifyIdentity) {
			window.netlifyIdentity.on("init", user => {
				if (!user) {
					window.netlifyIdentity.on("login", () => {
						document.location.href = "/cms/";
					});
				}
			});
		}
	</script>
</body>
</html>
